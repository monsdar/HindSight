{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block title %}{% trans "Add Event Outcomes" %} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
&rsaquo; <a href="{% url 'admin:app_list' app_label=opts.app_label %}">{{ opts.app_config.verbose_name }}</a>
&rsaquo; <a href="{% url 'admin:predictions_eventoutcome_changelist' %}">{{ opts.verbose_name_plural|capfirst }}</a>
&rsaquo; {% trans 'Add Event Outcomes' %}
</div>
{% endblock %}

{% block content %}
<h1>{% trans "Add Event Outcomes" %}</h1>

{% if events_data %}
    <p class="help">
        {% trans "Select the winning option for each event below. Only events past their deadline without outcomes are shown." %}
    </p>

    <form method="post" id="batch-outcomes-form">
        {% csrf_token %}
        
        <div class="results">
            <table id="result_list">
                <thead>
                    <tr>
                        <th scope="col">{% trans "Event" %}</th>
                        <th scope="col">{% trans "Deadline" %}</th>
                        <th scope="col">{% trans "Tip Type" %}</th>
                        <th scope="col">{% trans "Winning Option" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for event_data in events_data %}
                        <tr class="{% cycle 'row1' 'row2' %}">
                            <td>
                                <strong>{{ event_data.event.name }}</strong>
                                {% if event_data.event.description %}
                                    <br><small class="help">{{ event_data.event.description|truncatewords:20 }}</small>
                                {% endif %}
                            </td>
                            <td>
                                {{ event_data.event.deadline|date:"M d, Y H:i" }}
                                <br><small class="help">
                                    {% blocktrans with days=event_data.event.deadline|timesince %}{{ days }} ago{% endblocktrans %}
                                </small>
                            </td>
                            <td>{{ event_data.event.tip_type.name }}</td>
                            <td>
                                <select name="winning_option_{{ event_data.event.id }}" id="id_winning_option_{{ event_data.event.id }}">
                                    <option value="">{% trans "Select winning option..." %}</option>
                                    {% for option in event_data.options %}
                                        <option value="{{ option.id }}">
                                            {{ option.label }}
                                            {% if option.option %}
                                                <em>({{ option.option.name }})</em>
                                            {% endif %}
                                        </option>
                                    {% endfor %}
                                </select>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="submit-row">
            <input type="submit" value="{% trans 'Submit Outcomes' %}" class="default" name="_save">
            <a href="{% url 'admin:predictions_eventoutcome_changelist' %}" class="button cancel-link">{% trans 'Cancel' %}</a>
        </div>
    </form>

    <script>
        (function($) {
            // Add some basic form validation
            $('#batch-outcomes-form').on('submit', function(e) {
                var hasSelection = false;
                $('select[name^="winning_option_"]').each(function() {
                    if ($(this).val()) {
                        hasSelection = true;
                        return false; // break
                    }
                });
                
                if (!hasSelection) {
                    e.preventDefault();
                    alert('{% trans "Please select at least one winning option before submitting." %}');
                    return false;
                }
            });
        })(django.jQuery);
    </script>

{% else %}
    <div class="messagelist">
        <div class="info">
            {% trans "No events found that need outcomes. All events either have outcomes already or haven't reached their deadline yet." %}
        </div>
    </div>
    
    <div class="submit-row">
        <a href="{% url 'admin:predictions_eventoutcome_changelist' %}" class="button default">{% trans 'Back to Event Outcomes' %}</a>
    </div>
{% endif %}

{% endblock %}
