{% comment %}
NBA game prediction card.
Shows team matchups with logos, venue, and game time.
Teams are directly selectable for predictions.
{% endcomment %}

<article class="prediction-card nba-game-card rounded-2xl border border-slate-800 bg-slate-900 p-5 shadow-lg {% if user_tip %}ring-2 ring-theme-accent/30 bg-gradient-to-br from-slate-900 to-slate-800{% endif %}">
  
  {# Header #}
  <header class="flex items-start justify-between gap-3">
    <div>
      <p class="text-xs uppercase tracking-wide text-slate-500">{{ event.tip_type.name }}</p>
      {% if card_context.playoff_context %}
        <p class="mt-1 text-xs font-semibold text-amber-400">
          {{ card_context.playoff_context.series_name }}
          {% if card_context.playoff_context.series_score %}
            ({{ card_context.playoff_context.series_score }})
          {% endif %}
        </p>
      {% endif %}
    </div>
    <div class="flex items-center gap-3">
      <div class="text-right">
        <p class="text-xs text-slate-500">Deadline</p>
        <p class="text-xs font-semibold text-slate-300">{{ event.deadline|date:"M d, H:i" }}</p>
      </div>
      {# Lock Button #}
      {% if active_user %}
        <button type="button" 
                class="lock-toggle-btn flex items-center justify-center w-8 h-8 rounded-full border-2 transition-all duration-200 hover:scale-105 {% if user_tip and user_tip.is_locked %}theme-accent-border{% else %}border-slate-600{% endif %} hover:bg-slate-700"
                data-event-id="{{ event.id }}"
                {% if lock_summary and lock_summary.available == 0 and not user_tip.is_locked %}disabled{% endif %}
                title="{% if user_tip and user_tip.is_locked %}Unlock this pick{% else %}Lock this pick{% endif %}">
          <span class="text-lg transition-transform duration-200">{% if user_tip and user_tip.is_locked %}üîí{% else %}üîì{% endif %}</span>
        </button>
      {% endif %}
    </div>
  </header>
  
  {# Team Matchup #}
  <div class="mt-4 rounded-lg border border-slate-800 bg-gradient-to-b from-slate-950 to-slate-900 p-4">
    <div class="flex items-center justify-between gap-4">
      
      {# Away Team - Selectable #}
      {% if active_user %}
        <button type="button" 
                class="team-select-btn flex-1 text-center p-3 rounded-lg border-2 transition-all duration-200 hover:bg-slate-700 {% if user_tip and user_tip.prediction_option_id == card_context.away_team_option_id %}theme-accent-border{% else %}border-slate-600{% endif %}"
                data-event-id="{{ event.id }}"
                data-option-id="{{ card_context.away_team_option_id }}"
                data-team-name="{{ card_context.away_team_tricode }}">
      {% else %}
        <div class="flex-1 text-center p-3 rounded-lg border-2 border-slate-700">
      {% endif %}
        {% if card_context.away_team_logo %}
          <img src="{{ card_context.away_team_logo }}" 
               alt="{{ card_context.away_team }}" 
               class="mx-auto h-16 w-16 object-contain"
               onerror="this.style.display='none'" />
        {% endif %}
        <p class="mt-2 text-xl font-bold text-slate-200">
          {{ card_context.away_team_tricode }}
        </p>
      {% if active_user %}</button>{% else %}</div>{% endif %}
      
      {# Separator #}
      <div class="flex flex-col items-center gap-1">
        <span class="text-2xl font-bold theme-accent-text">@</span>
      </div>
      
      {# Home Team - Selectable #}
      {% if active_user %}
        <button type="button" 
                class="team-select-btn flex-1 text-center p-3 rounded-lg border-2 transition-all duration-200 hover:bg-slate-700 {% if user_tip and user_tip.prediction_option_id == card_context.home_team_option_id %}theme-accent-border{% else %}border-slate-600{% endif %}"
                data-event-id="{{ event.id }}"
                data-option-id="{{ card_context.home_team_option_id }}"
                data-team-name="{{ card_context.home_team_tricode }}">
      {% else %}
        <div class="flex-1 text-center p-3 rounded-lg border-2 border-slate-700">
      {% endif %}
        {% if card_context.home_team_logo %}
          <img src="{{ card_context.home_team_logo }}" 
               alt="{{ card_context.home_team }}" 
               class="mx-auto h-16 w-16 object-contain"
               onerror="this.style.display='none'" />
        {% endif %}
        <p class="mt-2 text-xl font-bold text-slate-200">
          {{ card_context.home_team_tricode }}
        </p>
      {% if active_user %}</button>{% else %}</div>{% endif %}
      
    </div>
  
  {# Prediction Status #}
  {% if not active_user %}
    <p class="mt-4 text-sm text-slate-400 text-center py-2">
      Activate a user to make predictions
    </p>
  {% endif %}
  
  {# Footer - Points Badge and User Prediction Badges #}
  <div class="mt-4 flex flex-wrap items-center justify-between gap-2">
    <div class="flex flex-wrap items-center gap-2">
      <span class="theme-accent-pill rounded-full px-3 py-1 text-xs font-semibold uppercase">
        {{ event.points }} pt{{ event.points|pluralize }}
      </span>
      {% if event.is_bonus_event %}
        <span class="text-xs font-semibold text-amber-400">‚≠ê Bonus Event</span>
      {% endif %}
    </div>
    
    {# User Prediction Badges #}
    {% if users_who_predicted %}
      <div class="flex flex-wrap items-center gap-1">
        <span class="text-xs text-slate-500">Predicted by:</span>
        {% for user in users_who_predicted %}
          <span class="inline-flex items-center gap-1 rounded-full border-2 px-2 py-1 text-xs font-medium {% if user == active_user %}theme-accent-bg theme-accent-border text-theme-accent-contrast{% else %}bg-slate-700/50 border-slate-600/50 text-slate-300{% endif %}">
            {% if user.display_name %}
              {{ user.display_name }}
            {% else %}
              {{ user.username }}
            {% endif %}
          </span>
        {% endfor %}
      </div>
    {% endif %}
  </div>
  
</article>

{# JavaScript for interactive functionality #}
<script>
// Use a global flag to prevent multiple initializations
if (!window.hooptippGameCardInitialized) {
  window.hooptippGameCardInitialized = true;
  
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing game card JavaScript...');
    
    // Team selection functionality
    const teamButtons = document.querySelectorAll('.team-select-btn');
    console.log('Found team buttons:', teamButtons.length);
    
    teamButtons.forEach(button => {
      // Check if listener already attached
      if (!button.hasAttribute('data-listener-attached')) {
        button.setAttribute('data-listener-attached', 'true');
        button.addEventListener('click', function() {
          console.log('Team button clicked:', this.dataset.eventId, this.dataset.optionId);
          const eventId = this.dataset.eventId;
          const optionId = this.dataset.optionId;
          const teamName = this.dataset.teamName;
          
          // Remove selection from other teams in this event
          const allTeamButtons = document.querySelectorAll(`[data-event-id="${eventId}"]`);
          allTeamButtons.forEach(btn => {
            btn.classList.remove('theme-accent-border');
            btn.classList.add('border-slate-600');
          });
          
          // Add selection to clicked team
          this.classList.remove('border-slate-600');
          this.classList.add('theme-accent-border');
                    
          // Save prediction immediately via AJAX
          savePredictionImmediately(eventId, optionId);
        });
      }
    });
    
    // Lock toggle functionality
    const lockButtons = document.querySelectorAll('.lock-toggle-btn');
    console.log('Found lock buttons:', lockButtons.length);
    
    lockButtons.forEach(button => {
      // Check if listener already attached
      if (!button.hasAttribute('data-listener-attached')) {
        button.setAttribute('data-listener-attached', 'true');
        button.addEventListener('click', function(e) {
          console.log('Lock button clicked for event:', this.dataset.eventId);
          e.preventDefault();
          e.stopPropagation();
          
          const eventId = this.dataset.eventId;
          const isCurrentlyLocked = this.querySelector('span').textContent === 'üîí';
          
          console.log('Current lock state:', isCurrentlyLocked);
          
          // Toggle lock state immediately via AJAX
          toggleLockImmediately(eventId, !isCurrentlyLocked, this);
        });
      }
    });
    
    // AJAX function to save prediction immediately
    async function savePredictionImmediately(eventId, optionId) {
      try {
        const response = await fetch('/api/save-prediction/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          },
          body: JSON.stringify({
            event_id: eventId,
            option_id: optionId
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          console.log('Prediction saved successfully:', data.message);
          // Show a subtle success indicator
          showTemporaryMessage('Prediction saved!', 'success');
        } else {
          console.error('Failed to save prediction:', data.error);
          showTemporaryMessage('Failed to save prediction: ' + data.error, 'error');
        }
      } catch (error) {
        console.error('Error saving prediction:', error);
        showTemporaryMessage('Error saving prediction', 'error');
      }
    }
    
    // AJAX function to toggle lock immediately
    async function toggleLockImmediately(eventId, shouldLock, buttonElement) {
      try {
        const response = await fetch('/api/toggle-lock/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          },
          body: JSON.stringify({
            event_id: eventId,
            should_lock: shouldLock
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          console.log('Lock toggled successfully:', data.message);
          
          // Update button appearance
          const lockSpan = buttonElement.querySelector('span');
          if (data.is_locked) {
            lockSpan.textContent = 'üîí';
            buttonElement.classList.remove('border-slate-600', 'border-2');
            buttonElement.classList.add('theme-accent-border', 'border-2');
            buttonElement.title = 'Unlock this pick';
          } else {
            lockSpan.textContent = 'üîì';
            buttonElement.classList.remove('theme-accent-border', 'border-2');
            buttonElement.classList.add('border-slate-600', 'border-2');
            buttonElement.title = 'Lock this pick';
          }
          
          // Update lock summary if available
          if (data.lock_summary) {
            updateLockSummary(data.lock_summary);
            
            // If locks are available, enable lock buttons
            if (data.lock_summary.available > 0) {
              enableLockButtons();
            } else {
              // If no locks available, disable remaining unlocked buttons
              // Use a small delay to ensure button state is updated first
              console.log('No locks available, disabling remaining buttons');
              setTimeout(() => {
                disableRemainingLockButtons();
              }, 100);
            }
          }
          
          showTemporaryMessage(data.message, 'success');
        } else {
          console.error('Failed to toggle lock:', data.error);
          showTemporaryMessage('Failed to toggle lock: ' + data.error, 'error');
        }
      } catch (error) {
        console.error('Error toggling lock:', error);
        showTemporaryMessage('Error toggling lock', 'error');
      }
    }
    
    // Function to show temporary messages
    function showTemporaryMessage(message, type) {
      // Create a temporary message element
      const messageEl = document.createElement('div');
      messageEl.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg text-sm font-medium transition-opacity duration-300 ${
        type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'
      }`;
      messageEl.textContent = message;
      
      document.body.appendChild(messageEl);
      
      // Remove after 3 seconds
      setTimeout(() => {
        messageEl.style.opacity = '0';
        setTimeout(() => messageEl.remove(), 300);
      }, 3000);
    }
    
    // Function to update lock summary display
    function updateLockSummary(lockSummary) {
      const lockSummaryEl = document.querySelector('.lock-summary-display');
      if (lockSummaryEl) {
        lockSummaryEl.textContent = `Locks remaining: ${lockSummary.available} / ${lockSummary.total}`;
      }
    }
    
    // Function to disable remaining lock buttons when limit reached
    function disableRemainingLockButtons() {
      const lockButtons = document.querySelectorAll('.lock-toggle-btn');
      lockButtons.forEach(button => {
        const isCurrentlyLocked = button.querySelector('span').textContent === 'üîí';
        if (!isCurrentlyLocked) {
          button.disabled = true;
          button.classList.add('opacity-50', 'cursor-not-allowed');
        }
      });
    }
    
    // Function to re-enable lock buttons when locks become available
    function enableLockButtons() {
      const lockButtons = document.querySelectorAll('.lock-toggle-btn');
      lockButtons.forEach(button => {
        const isCurrentlyLocked = button.querySelector('span').textContent === 'üîí';
        if (!isCurrentlyLocked) {
          button.disabled = false;
          button.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      });
    }
  });
}
</script>
