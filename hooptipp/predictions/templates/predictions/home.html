{% extends 'base.html' %}
{% load prediction_extras %}

{% block title %}HoopTipp &ndash; Weekly overview{% endblock %}

{% block content %}
  <section class="mb-8">
    <h1 class="text-3xl font-bold text-amber-300 mb-3">Weekly picks</h1>
    <p class="text-slate-300 max-w-2xl">
      Select a user to submit picks for the upcoming games. When no user is active you will not see any saved predictions.
    </p>
  </section>

  <section class="mb-10">
    <form method="post" class="flex flex-wrap items-end gap-3 bg-slate-900 border border-slate-800 rounded-xl p-4">
      {% csrf_token %}
      <input type="hidden" name="set_active_user" value="1" />
      <div>
        <label for="user_id" class="block text-sm font-semibold text-slate-400 uppercase tracking-wide">Active user</label>
        <select id="user_id" name="user_id" class="mt-2 w-64 rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-slate-100 focus:border-amber-400 focus:outline-none">
          <option value="">No active user</option>
          {% for user in users %}
            <option value="{{ user.id }}" {% if active_user and user.id == active_user.id %}selected{% endif %}>{{ user.username }}</option>
          {% endfor %}
        </select>
      </div>
      <button type="submit" class="inline-flex items-center gap-2 rounded-lg bg-amber-400 px-4 py-2 font-semibold text-slate-900 shadow-lg shadow-amber-500/30 transition hover:bg-amber-300">
        Activate user
      </button>
    </form>
  </section>

  {% if not tip_type %}
    <div class="rounded-2xl border border-slate-800 bg-slate-900 p-6 text-slate-300">
      <h2 class="text-xl font-semibold text-amber-300">No games found</h2>
      <p class="mt-2">The BallDontLie API could not provide any games for the upcoming week. Please try again later.</p>
    </div>
  {% else %}
    <section class="space-y-6">
      <header class="flex flex-wrap items-center justify-between gap-4">
        <div>
          <h2 class="text-2xl font-semibold text-amber-300">Featured games</h2>
          <p class="text-sm text-slate-400">Picks are open until {{ tip_type.deadline|date:"M d, Y H:i" }}.</p>
        </div>
        {% if not active_user %}
          <p class="text-sm text-slate-400">Activate a user to display or submit picks.</p>
        {% endif %}
      </header>

      <div class="grid gap-4 md:grid-cols-2">
        {% for game in games %}
          <article class="rounded-2xl border border-slate-800 bg-slate-900 p-5 shadow-lg shadow-slate-900/40">
            <div class="flex items-center justify-between text-sm text-slate-400">
              <span>{{ game.game_date|date:"M d, Y H:i" }}</span>
              {% if game.venue %}
                <span>{{ game.venue }}</span>
              {% endif %}
            </div>
            <div class="mt-4 space-y-3">
              <div class="flex items-center justify-between">
                <span class="text-lg font-semibold text-slate-200">{{ game.away_team_tricode }}</span>
                <span class="text-xs uppercase tracking-wide text-slate-500">@</span>
                <span class="text-lg font-semibold text-slate-200">{{ game.home_team_tricode }}</span>
              </div>
              <p class="text-sm text-slate-400">
                {{ game.away_team }} <span class="text-amber-400">@</span> {{ game.home_team }}
              </p>
            </div>

            {% with pick_users=game_tip_users|get_item:game.id %}
              {% if pick_users %}
                <div class="mt-4 flex flex-wrap items-center gap-2 text-xs">
                  <span class="font-semibold uppercase tracking-wide text-slate-500">Picked by</span>
                  <div class="flex flex-wrap gap-1">
                    {% for pick_user in pick_users %}
                      <span
                        class="inline-flex h-6 w-6 items-center justify-center rounded-full border border-amber-500/40 bg-amber-500/10 font-semibold text-amber-200"
                        title="{{ pick_user.username }}"
                        aria-label="{{ pick_user.username }}"
                      >
                        {{ pick_user.username|slice:':1'|upper }}
                      </span>
                    {% endfor %}
                  </div>
                </div>
              {% endif %}
            {% endwith %}

            {% if active_user %}
              <div class="mt-4">
                <fieldset class="space-y-2">
                  <legend class="text-xs uppercase tracking-wide text-slate-500">Your pick</legend>
                  <label class="flex items-center gap-2 rounded-lg border border-slate-800 bg-slate-950 px-3 py-2 text-sm hover:border-amber-400">
                    <input type="radio" name="prediction_{{ game.id }}" value="{{ game.away_team_tricode }}" form="tips-form" class="text-amber-400 focus:ring-amber-400"
                      {% if user_tips|get_item:game.id and user_tips|get_item:game.id.prediction == game.away_team_tricode %}checked{% endif %} />
                    <span class="flex-1">{{ game.away_team }} wins</span>
                  </label>
                  <label class="flex items-center gap-2 rounded-lg border border-slate-800 bg-slate-950 px-3 py-2 text-sm hover:border-amber-400">
                    <input type="radio" name="prediction_{{ game.id }}" value="{{ game.home_team_tricode }}" form="tips-form" class="text-amber-400 focus:ring-amber-400"
                      {% if user_tips|get_item:game.id and user_tips|get_item:game.id.prediction == game.home_team_tricode %}checked{% endif %} />
                    <span class="flex-1">{{ game.home_team }} wins</span>
                  </label>
                </fieldset>
              </div>
            {% endif %}

            {% if active_user and user_tips|get_item:game.id %}
              <p class="mt-3 text-xs text-slate-500">Last updated: {{ user_tips|get_item:game.id.updated_at|date:"M d, Y H:i" }}</p>
            {% endif %}
          </article>
        {% endfor %}
      </div>

      {% if active_user %}
        <form id="tips-form" method="post" class="rounded-2xl border border-amber-500/30 bg-amber-500/10 p-5 backdrop-blur">
          {% csrf_token %}
          <input type="hidden" name="save_tips" value="1" />
          <p class="text-sm text-amber-200 mb-4">Picks are automatically stored for <span class="font-semibold">{{ active_user.username }}</span>.</p>
          <button type="submit" class="inline-flex items-center gap-2 rounded-lg bg-amber-400 px-5 py-2 font-semibold text-slate-900 shadow-lg shadow-amber-500/30 transition hover:bg-amber-300">
            Save picks
          </button>
        </form>
      {% endif %}
    </section>
  {% endif %}
{% endblock %}
