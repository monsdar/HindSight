# Generated by Django 5.2 on 2025-10-24 06:09

from django.db import migrations

def backfill_eventoutcome_metadata(apps, schema_editor):
    """Backfill metadata for existing EventOutcomes that have NBA games."""
    EventOutcome = apps.get_model('predictions', 'EventOutcome')
    
    # Get all EventOutcomes that don't have metadata and have NBA games
    outcomes_to_update = EventOutcome.objects.filter(
        metadata__isnull=True,
        prediction_event__scheduled_game__isnull=False
    ).select_related('prediction_event__scheduled_game')
    
    updated_count = 0
    
    for outcome in outcomes_to_update:
        game = outcome.prediction_event.scheduled_game
        
        # Create metadata from the scheduled game data
        # Note: We can't get live scores here since this is a migration
        # But we can store the basic game information
        metadata = {
            'away_team': game.away_team_tricode,
            'home_team': game.home_team_tricode,
            'away_team_full': game.away_team,
            'home_team_full': game.home_team,
            'game_status': 'Final',  # Assume final since outcome exists
            'nba_game_id': game.nba_game_id,
            # Scores will be None since we can't fetch them in migration
            'away_score': None,
            'home_score': None,
        }
        
        outcome.metadata = metadata
        outcome.save(update_fields=['metadata'])
        updated_count += 1
    
    print(f"Updated metadata for {updated_count} EventOutcomes")


def reverse_backfill_eventoutcome_metadata(apps, schema_editor):
    """Remove metadata from EventOutcomes (reverse operation)."""
    EventOutcome = apps.get_model('predictions', 'EventOutcome')
    
    # Clear metadata for all EventOutcomes
    EventOutcome.objects.all().update(metadata={})

class Migration(migrations.Migration):

    dependencies = [
        ('predictions', '0008_eventoutcome_metadata'),
    ]

    operations = [
        migrations.RunPython(
            backfill_eventoutcome_metadata,
            reverse_backfill_eventoutcome_metadata,
        ),
    ]
